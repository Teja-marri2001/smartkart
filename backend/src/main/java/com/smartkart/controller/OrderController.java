package com.smartkart.controller; import com.smartkart.model.*; import com.smartkart.repo.*; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.security.core.Authentication; import org.springframework.web.bind.annotation.*; import java.math.BigDecimal; import java.util.*; @RestController @RequestMapping("/api/orders") @CrossOrigin public class OrderController { @Autowired private OrderRepository orderRepo; @Autowired private CartItemRepository cartRepo; @Autowired private UserRepository userRepo; @PostMapping("/checkout") public Order checkout(Authentication auth){ User u = userRepo.findByEmail(auth.getName()).orElseThrow(); List<CartItem> items = cartRepo.findByUser(u); if(items.isEmpty()) throw new RuntimeException("Cart is empty"); Order order = new Order(); order.setUser(u); List<OrderItem> orderItems = new ArrayList<>(); for(CartItem ci: items){ OrderItem oi = new OrderItem(); oi.setProduct(ci.getProduct()); oi.setQuantity(ci.getQuantity()); oi.setPrice(new BigDecimal(ci.getProduct().getPrice().toString())); orderItems.add(oi); } order.setItems(orderItems); order = orderRepo.save(order); cartRepo.deleteByUser(u); return order; } @GetMapping public List<Order> myOrders(Authentication auth){ User u = userRepo.findByEmail(auth.getName()).orElseThrow(); return orderRepo.findByUser(u); } }